"use strict";class t{constructor(){this.viewers=[]}addViewer(t){this.viewers.push(t)}publish(){this.viewers.forEach((t=>{t.update()}))}}const e=t=>null!==t&&"object"==typeof t;class n{constructor(e){this.publisher=new t,this.obj2Proxy=new WeakMap,e.data=this.hijack(e.data)}hijack(n){const o=this;return e(n)?new Proxy(n,{get(n,s,r){const i=Reflect.get(n,s,r);if(t.viewer&&o.publisher.addViewer(t.viewer),e(i)){const t=o.obj2Proxy.get(i);if(t)return t;{const t=o.hijack(i);o.obj2Proxy.set(i,t)}}return i},set(t,e,n,s){const r=Reflect.set(t,e,n,s);return o.publisher.publish(),r},deleteProperty(t,e){const n=Reflect.deleteProperty(t,e);return o.publisher.publish(),n}}):n}}const o=(t,e)=>{const n=e.split(".");if(n.length>1){const e=n.pop(),o=n.reduce(((t,e)=>t[e]),t.data);return[o[e],t=>{o[e]=t}]}{const e=n[0],o=t.data;return[o[e],t=>{o[e]=t}]}},s=t=>{if("object"===typeof t){if(Array.isArray(t))return Array.from(t);{const e={};return Object.keys(t)?.forEach((t=>{e[t]=s(e[t])})),e}}return t};class r{constructor(e,n,r,i){this.mud=e,this.dataKey=n,this.updateHandler=r,this.node=i,t.viewer=this,this.oldValue=s(o(e,n)[0]),t.viewer=null}update(){const t=o(this.mud,this.dataKey)[0];((t,e)=>{const n=typeof t;return n!==typeof e||(["function","object"].includes(n)?t.toString()!==e.toString():t!==e)})(this.oldValue,t)&&(this.oldValue=s(t),this.updateHandler(t,this.node))}}const i=(t,e,n)=>{const{name:o,value:s}=n;if("if"===o){const n=t.data[s];let o=null;const i=(t,e)=>{t?o&&o.parentNode.replaceChild(e,o):o=(t=>{const e=document.createComment("if");return t.parentNode?.replaceChild(e,t),e})(e)};new r(t,s,i,e),i(n,e)}};class c{constructor(t){this.mud=t,this.el=t.el,this.compile(this.el)}compile(t){const e=t.childNodes;Array.from(e).forEach((t=>{1===t.nodeType?this.compileForElement(t):3===t.nodeType&&this.compileForText(t),t.childNodes.length&&this.compile(t)}))}compileForElement(t){Array.from(t.attributes).forEach((e=>{((t,e,n)=>{const{name:s,value:i}=n;if("props"===s)return;const c=/\{(.+?)\}/,a=i?.match(c);if(a){const n=a[1],[d,l]=o(t,n);if(void 0===d)return;const h=t=>{e[s]=t};new r(t,n,h),e.addEventListener("input",(()=>{l(e.value)})),h(i.replace(c,d))}})(this.mud,t,e),((t,e,n)=>{const{name:o,value:s}=n;if("for"===o){const[n,o]=s.split(":").map((t=>t?.trim())),i=t.data[o],c=new RegExp(`{${n}}`),a=`${e.innerHTML}`,d=(t,e)=>{const n=t?.reduce(((t,e)=>{let n=a;return a.match(c)&&(n=a.replace(c,e)),t+n}),"");e.innerHTML=n};new r(t,o,d,e),d(i,e)}})(this.mud,t,e),i(this.mud,t,e)})),((t,e)=>{const n=e.tagName?.toLowerCase(),s=t?.components?.[n];if(!s)return;const i=document.createElement("iframe"),c=()=>{const t=i.contentDocument;i.width=t?.body?.offsetWidth||0,i.height=t?.body?.scrollHeight||0},a=e.attributes?.props?.nodeValue,d=a?.match(/\{(.+?)\}/);i.height=0,i.scrolling="no",i.style.width="100%",i.style.border="none",i.src=s,i.onload=()=>{const e=i.contentDocument,n=i.contentWindow;d&&d[1].split(",")?.forEach((e=>{const s=e.trim().split(":"),i=s[0],c=s[1]??i,[a,d]=o(t,c);n.mud.data[i]=a,new r(t,c,(t=>{n.mud.data[i]=t})),n.mud.watch(i,(t=>{d(t)}))})),e.head.innerHTML='\n      <META HTTP-EQUIV="pragma" CONTENT="no-cache">\n      <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">\n      <META HTTP-EQUIV="expires" CONTENT="0">\n    ',e.body.style.margin=0,e.body.addEventListener("DOMSubtreeModified",(()=>{c()}),!1),c()},e.appendChild(i)})(this.mud,t)}compileForText(t){((t,e,n)=>{const s=/\{(.+?)\}/,i=n.match(s);if(i){const c=i[1],[a]=o(t,c);if(void 0===a)return;const d=t=>{e.textContent=n.replace(s,t)};new r(t,c,d),d(a)}})(this.mud,t,t.textContent)}}module.exports=class{constructor(t){window.mud=this,this.el=document.querySelector(t.el),this.data=t.data,this.components=t.components,this.watch=(t,e)=>{new r(this,t,e)},new n(this),new c(this),t.onMount?.()}},"undefined"!=typeof window&&(window.MUD_VERSION="1.2.1");
