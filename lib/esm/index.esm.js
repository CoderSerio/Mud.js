class e{constructor(){this.viewers=[]}addViewer(e){this.viewers.push(e)}publish(){this.viewers.forEach((e=>{e.update()}))}}const t=e=>null!==e&&"object"==typeof e;class n{constructor(t){this.publisher=new e,this.obj2Proxy=new WeakMap,t.data=this.hijack(t.data)}hijack(n){const o=this;return t(n)?new Proxy(n,{get(n,s,r){const i=Reflect.get(n,s,r);if(e.viewer&&o.publisher.addViewer(e.viewer),t(i)){const e=o.obj2Proxy.get(i);if(e)return e;{const e=o.hijack(i);o.obj2Proxy.set(i,e)}}return i},set(e,t,n,s){const r=Reflect.set(e,t,n,s);return o.publisher.publish(),r},deleteProperty(e,t){const n=Reflect.deleteProperty(e,t);return o.publisher.publish(),n}}):n}}const o=(e,t)=>{const n=t.split(".");if(n.length>1){const t=n.pop(),o=n.reduce(((e,t)=>e[t]),e.data);return[o[t],e=>{o[t]=e}]}{const t=n[0],o=e.data;return[o[t],e=>{o[t]=e}]}},s=e=>{if("object"===typeof e){if(Array.isArray(e))return Array.from(e);{const t={};return Object.keys(e)?.forEach((e=>{t[e]=s(t[e])})),t}}return e};class r{constructor(t,n,r,i,a,c){this.mud=t,this.dataKey=n,this.updateHandler=r,this.node=i,this.ifNodeList=a,this.ifNodeIndex=c,e.viewer=this,this.oldValue=s(o(t,n)[0]),e.viewer=null}update(){const e=o(this.mud,this.dataKey)[0];((e,t)=>{const n=typeof e;return n!==typeof t||(["function","object"].includes(n)?e.toString()!==t.toString():e!==t)})(this.oldValue,e)&&(this.ifNodeList&&(this.oldValue=e),this.node?this.updateHandler(this.ifNodeList):(this.oldValue=s(e),this.updateHandler(e,this.node)))}}const i=(e,t)=>{if(t)return t.parentNode||e.parentNode.replaceChild(t,e),t;{const t=document.createComment("if");return e.parentNode.replaceChild(t,e),t}},a=(e,t)=>{t.parentNode.replaceChild(e,t)},c=(e,t,n,o,s,r=0)=>{const c=n?.length??0;if(e){t.get(o[s])&&(a(n[s].node,o[s]),t.set(o[s],!1));for(let e=r;e<c;e++)o[e]=i(n[e].node,o[e]),t.set(o[e],!0);return!0}return o[s]=i(n[s].node,o[s]),t.set(o[s],!0),!1};class l{constructor(e){this.mud=e,this.el=e.el,this.compile(this.el)}compile(e){const t=e.childNodes;Array.from(t).forEach((e=>{1===e.nodeType?this.compileForElement(e):3===e.nodeType&&this.compileForText(e),e.childNodes.length&&this.compile(e)}))}compileForElement(e){Array.from(e.attributes).forEach((t=>{((e,t,n)=>{const{name:s,value:i}=n;if("props"===s)return;const a=/\{(.+?)\}/,c=i?.match(a);if(c){const n=c[1],[l,d]=o(e,n);if(void 0===l)return;const u=e=>{t[s]=e};new r(e,n,u),t.addEventListener("input",(()=>{d(t.value)})),u(i.replace(a,l))}})(this.mud,e,t),((e,t,n)=>{const{name:o,value:s}=n;if("for"===o){const[n,o]=s.split(":").map((e=>e?.trim())),i=e.data[o],a=new RegExp(`{${n}}`),c=`${t.innerHTML}`,l=(e,t)=>{const n=e?.reduce(((e,t)=>{let n=c;return c.match(a)&&(n=c.replace(a,t)),e+n}),"");t.innerHTML=n};new r(e,o,l,t),l(i,t)}})(this.mud,e,t),((e,t,n)=>{const{name:s,value:i}=n;let l=null;const d=[];if("if"!==s)return;l=((e,t,n)=>{const o=[];o.push({node:e,name:t,value:n});const s=e=>{const t=e?.nextElementSibling;if(!t?.attributes?.[0])return o;const{name:n,value:r}=t.attributes[0];return"else-if"===n?(o.push({node:t,name:n,value:r}),s(t)):"else"===n?(o.push({node:t,name:n,value:r}),o):o};return s(e)})(t,s,i);const u=new Map,h=t=>{const n=t.length;if("else"!==t[n-1].name)for(let s=0;s<n;s++){const[n]=o(e,t[s].value);if(c(n,u,t,d,s,s+1))break}else for(let s=0;s<n;s++){const[r]=o(e,t[s].value);if(s===n-1){u.get(d[s])&&(a(t[s].node,d[s]),u.set(d[s],!1));break}if(c(r,u,t,d,s,s+1))break}};l.forEach(((t,n)=>{new r(e,l[n].value,h,l[n].node,l,n)})),h(l)})(this.mud,e,t)})),((e,t)=>{const n=t.tagName?.toLowerCase(),s=e?.components?.[n];if(!s)return;const i=document.createElement("iframe"),a=()=>{const e=i.contentDocument;i.width=e?.body?.offsetWidth||0,i.height=e?.body?.scrollHeight||0},c=t.attributes?.props?.nodeValue,l=c?.match(/\{(.+?)\}/);i.height=0,i.scrolling="no",i.style.width="100%",i.style.border="none",i.src=s,i.onload=()=>{const t=i.contentDocument,n=i.contentWindow;l&&l[1].split(",")?.forEach((t=>{const s=t.trim().split(":"),i=s[0],a=s[1]??i,[c,l]=o(e,a);n.mud.data[i]=c,new r(e,a,(e=>{n.mud.data[i]=e})),n.mud.watch(i,(e=>{l(e)}))})),t.head.innerHTML='\n      <META HTTP-EQUIV="pragma" CONTENT="no-cache">\n      <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">\n      <META HTTP-EQUIV="expires" CONTENT="0">\n    ',t.body.style.margin=0,t.body.addEventListener("DOMSubtreeModified",(()=>{a()}),!1),a()},t.appendChild(i)})(this.mud,e)}compileForText(e){((e,t,n)=>{const s=/\{(.+?)\}/,i=n.match(s);if(i){const a=i[1];let[c]=o(e,a);if(void 0===c)return;"object"==typeof c&&(c=JSON.stringify(c),console.log(c));const l=e=>{t.textContent=n.replace(s,e)};new r(e,a,l),l(c)}})(this.mud,e,e.textContent)}}class d{constructor(e){window.mud=this,this.el=document.querySelector(e.el),this.data=e.data,this.components=e.components,this.watch=(e,t)=>{new r(this,e,t)},new n(this),new l(this),e.onMount?.()}}export{d as default};"undefined"!=typeof window&&(window.MUD_VERSION="1.3.1");
